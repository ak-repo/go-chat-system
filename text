func RateLimit(limit int, window time.Duration) func(http.Handler) http.Handler {
	script := redis.NewScript(`
        redis.call("ZADD", KEYS[1], ARGV[1], ARGV[4])
        redis.call("ZREMRANGEBYSCORE", KEYS[1], 0, ARGV[1] - ARGV[2])
        local count = redis.call("ZCARD", KEYS[1])
        if count > tonumber(ARGV[3]) then
            return 0
        end
        redis.call("EXPIRE", KEYS[1], ARGV[2])
        return 1
    `)

	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {

			userID := r.Header.Get("X-User-ID")
			if userID == "" {
				http.Error(w, "missing user id", http.StatusBadRequest)
				return
			}

			key := "rate:user:" + userID
			now := time.Now().Unix()
			reqID := uuid.NewString()

			allowed, err := script.Run(
				r.Context(),
				rdb,
				[]string{key},
				now,
				int(window.Seconds()),
				limit,
				reqID,
			).Int()

			if err != nil {
				http.Error(w, "redis error", http.StatusInternalServerError)
				return
			}

			if allowed == 0 {
				http.Error(w, "rate limit exceeded", http.StatusTooManyRequests)
				return
			}

			next.ServeHTTP(w, r)
		})
	}
}
